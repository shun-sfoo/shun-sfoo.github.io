# JVM 虚拟机介绍

## Sun HotSpot VM

优点:
热点探测技术.通过执行计数器找出最具优化价值的代码,
然后通知 jit 编辑器以方法为单位进行深度优化编译.

## 虚拟机

Java 代码经过编译后生成符合规范的字节码文件， Java 虚拟机通过翻译讲字节码文件生成
对应平台的机器码。

## 编译器

### 前段编译器

- Sun 的 javac
- Eclipse JDT 中的增量式编译器

将 java 代码翻译成字节码，分为四个阶段：

1. 词法、语法分析。 在这个阶段， JVM 会对源代码的字符进行一次扫描， 最终生成一个抽象的语法树。
   简单地说，在这个节点 JVM 会搞懂我们的代码到底的想要干什么。 就像我们分析一个句子一样，我们会对
   句子划分主谓宾，弄清楚这个句子要表达的意思一样。
2. 填充符号表。我们知道类之间是会相互引用的， 但在编译阶段，我们无法确定其具体地址，
   所以我们会使用一个符号来替代。在这个阶段做的就是类似的事情，即对抽象的类或接口进行符号填充。
   等到类加载阶段， JVM 会将符号替换成具体的内存地址。
3. 注解处理。 我们知道 Java 是支持注解的， 因此在这个阶段会对注解进行分析， 根据注解的作用将其
   还原成具体的指令集。
4. 分析与字节码生成。到了这个阶段， JVM 便会根据上面几个阶段分析出来的结果，进行字节码的生成，
   最终输出为 class 文件。

一般称 javac 编译器为前段编译器， 因为其发生在整个编译的前期。

### JIT 编译器

- HotSpot VM Client Compiler (C1)
- HotSpot VM Server Compiler (C2)

当源代码转换成字节码之后，运行程序有两种选择。一种是使用 Java 解释器执行字节码，
另一种则是通过使用 JIT 编译器将字节码转化为本地机器吗。

这两种方法的区别在于， 前者启动速度快而运行速度慢， 而后者启动速度慢但运行速度快。
其原因在于， 解释器不用像 JIT 编译器一样将所有字节码转化为机器码， 自然省去了优化的时间。
而当 JIT 编译器完成第一次编译后， 其会将字节码对应的机器码保存下来， 下次可以直接使用。
实际情况中，为了运行速度和效率，通常采用两者相结合的方式编译执行。

#### C1 编译模式和 C2 编译模式的区别

C1 编译模式会将字节码编译成本地代码， 进行简单、可靠的优化，如有必要将加入性能监控逻辑。
C2 编译模式也是将字节码编译成本地代码，但是会启用一些编译耗时较长的优化，甚至会根据性能
监控信息进行一些不可靠的激进优化。

简单来说 C1 编译模式做的优化相对保守，其编译速度比 C2 较快。 而 C2 编译模式会做一些激进的优化，
并且会根据性能监控做针对优化，所以其编译质量较好，但耗时更长。

#### 编译模式的选择

- 混合模式(Mixed Mode)。即 C1 和 C2 两种模式混合起来使用，这是默认的运行模式。
  单独使用 C1 或者 C2, 使用 `-client` 或 `-server` 打开即可。
- 解释模式(Interpreted Mode)。即所有代码都解释执行， 使用 `-Xint` 参数会打开这个模式。
- 编译模式 (Compiled Mode)。此模式优先采用编译， 但是无法编译时也会执行解释，
  使用 `Xcomp` 打开这种模式。

### AOT 编译器

- GNU Compiler for the Java(GCJ)
- Excelsior JET

AOT 编译器的基本思想是： 在程序执行前生成 Java 方法的本地代码，以便在程序运行时
直接使用本地代码。

但是 Java 语言本身的动态特性带来了额外的复杂性，影响了 Java 程序静态编译的代码质量。
例如 Java 语言重的动态类的加载，因为 AOT 是在程序运行前编译的，所以无法获知这一信息，
所以会导致一些问题的产生。

总的来说 AOT 编译器从编译质量上来看，肯定比不上 JIT 编译器。其存在的目的在于避免 JIT
编译器的运行时性能消耗或内存消耗，或者避免解释程序的早期性能开销。

在运行速度上来说，AOT 编译器编译出来的代码比 JIT 编译出来的慢， 但是比解释执行的快。
而在编译时间上，AOT 也是一个始终的速度。所以说 AOT 编译器的存在是 JVM 牺牲质量换性能的
一种策略。就如 JVM 其运行模式中选择 Mixed 混合模式一样，使用 C1 编译模式只进行简单的优化，
而 C2 编译模式则进行较为激进的优化。充分利用两种模式的优点，从而达到最优的运行效率。

### 编译器总结

- 编译速度， 解释执行 > AOT 编译器 > JIT 编译器。
- 编译质量， JIT 编译器 > AOT 编译器 > 解释执行。

# 参考来源

[陈树义的博客](https://www.cnblogs.com/chanshuyi/p/jvm_serial_04_from_source_code_to_machine_code.html)
